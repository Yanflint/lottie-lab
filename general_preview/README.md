# General Preview — Mobile Viewer (PWA)

Лёгкий PWA-вьювер, который каждые N секунд запрашивает *последнюю созданную ссылку* и отображает её во фрейме.
Работает на статическом хостинге (включая Яндекс Облако / Object Storage / S3 / любой CDN).

## Как это работает

- Приложение читает `config.json` (без кэша) и узнаёт:
  - `latestUrlPath` — путь к файлу с последней ссылкой (например, `/latest.txt` или `/latest.json`).
  - `pollIntervalMs` — интервал автообновления в миллисекундах (по умолчанию 5000).
- Каждые `pollIntervalMs` выполняется запрос `GET latestUrlPath?t=TIMESTAMP` с `cache: 'no-store'`. Это обходит агрессивный кэш CDN и сервис-воркера.
- Ответ может быть:
  - **Простой текст** со ссылкой (абсолютной или относительной).
  - **JSON** с полем `url` (`href`/`link` тоже принимаются).
- Если ссылка изменилась — она подставляется в `<iframe>` и становится доступной по кнопке **«Открыть текущую ссылку»**.

> ⚠️ Важно: сервис-воркер настроен в режиме **network-first** для `latest.txt/json` и `config.json`, чтобы не кэшировать их.

## Быстрый старт (локально)

1. Содержимое папки `general_preview` положите на любой статический сервер.
2. Проверьте, что по адресу `config.json` доступна конфигурация. Для теста есть дефолтная:
   ```json
   { "latestUrlPath": "mock/latest.txt", "pollIntervalMs": 5000 }
   ```
3. Откройте `/index.html` — загрузится демо-страница из `samples/sample.html`.
4. Поменяйте `mock/latest.txt` на вашу реальную ссылку или укажите путь к файлу `latest.txt`/`latest.json` в `config.json`.

## Деплой в Яндекс Облако (Object Storage)

- Загрузите папку целиком, сохраните файловую структуру.
- В идеале для `latest.txt`/`latest.json` выставьте заголовки `Cache-Control: no-store, no-cache, must-revalidate`.
- Если менять заголовки нельзя — не страшно: приложение добавляет уникальный query-параметр `?t=TIMESTAMP`, поэтому CDN вернёт свежий объект.
- Убедитесь, что сайт открыт по HTTPS — для PWA и сервис-воркера это обязательно.

## Частые причины, почему «перестало работать» после миграции

- CDN кэширует `latest.txt`/`latest.json`, и старый PWA показывал устаревшую ссылку. Здесь это обойдёно query-параметром и `cache: 'no-store'`.
- Старый сервис-воркер кэшировал динамику. В этом PWA — **network-first** для динамических путей.
- CORS: мы не делаем `fetch` к «превью-странице», а просто вставляем её в `<iframe>`, поэтому CORS не мешает показу. `fetch` нужен только к `latest.txt/json` на **вашем** домене.

## Настройка

- `config.json`:
  ```json
  {
    "latestUrlPath": "/latest.txt",
    "pollIntervalMs": 5000
  }
  ```
- Можно указать `latestUrlPath` как абсолютный (`https://example.com/path/latest.txt`) или относительный путь (`/latest.txt`).

## Формат файла «последней ссылки»

- **Текст**: просто URL в одну строку.
- **JSON**:
  ```json
  { "url": "https://example.com/preview/index.html" }
  ```
  Также подхватятся поля `href` или `link`.

## Обновление ссылки генератором

Ваш генератор превью должен перезаписывать `latest.txt` или `latest.json` на статическом хостинге каждый раз при создании новой ссылки.

## Иконки и PWA

Включены `icons/icon-192.png` и `icons/icon-512.png`. Приложение работает как standalone PWA, поддерживает добавление на домашний экран.

---

**Подсказка для отладки**: откройте DevTools → Network и убедитесь, что запросы к `config.json` и `latest.txt` уходят **с новым query-параметром** и не берутся из кэша.
