name: Deploy static site to Yandex Object Storage

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate build.js
        run: |
          mkdir -p general_preview
          SHORT=$(echo "$GITHUB_SHA" | cut -c1-7)
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > general_preview/build.js <<EOF
          // auto-generated by CI
          window.__BUILD__ = {
            sha: "$GITHUB_SHA",
            short: "$SHORT",
            run: "$GITHUB_RUN_NUMBER",
            ts: "$TS",
            branch: "$GITHUB_REF_NAME",
            repo: "$GITHUB_REPOSITORY"
          };
          EOF

      - name: Sync to Object Storage
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ru-central1
        run: |
          aws s3 sync ./general_preview s3://${{ vars.S3_BUCKET }}             --delete --acl public-read             --endpoint-url https://storage.yandexcloud.net

      - name: Set no-cache for build.js
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ru-central1
        run: |
          aws s3 cp general_preview/build.js s3://${{ vars.S3_BUCKET }}/build.js             --acl public-read             --cache-control "no-cache, max-age=0"             --endpoint-url https://storage.yandexcloud.net
